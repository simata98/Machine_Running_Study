import csv
import glob


some = ["byte", "short", "dword", "ptr"]


def filter_list(input_line):
    temp = input_line.split(" ")
    temp = list(filter(("").__ne__, temp))
    l = len(temp)
    i = 0
    while i != (l - 1):
        temp[i] = temp[i].strip("\n")
        temp[i] = temp[i].strip(",")
        # merge elements in some
        if temp[i] in some:
            temp[i - 1] = temp[i - 1] + " " + temp[i]
            temp.remove(temp[i])
            l = l - 1
        else:
            i += 1
    return temp


if __name__ == "__main__":
    # read filenames
    asmfiles = []
    for file in glob.glob("./test_benign/*.asm"):
        asmfiles.append(file)

    for path in asmfiles:
        source = open(path, "r", encoding="cp949")
        t = path.split("/")
        t = t[1].split(".")[0]
        # read instructions from asm file
        final = []
        for source_lines in source.readlines():
            source_lines = filter_list(source_lines)
            final.append(source_lines)

        # Write to CSV file
        column_names = ["Instruction", "opcode_1", "opcode_2"]
        with open("./csv_files/" + t + ".csv", "w+", newline="") as f:
            write = csv.writer(f)
            write.writerow(column_names)
            write.writerows(final)
